<div class="container">
  <header>
    <h1>J-Stock Auto Planner <span class="subtitle">powered by Antigravity</span></h1>
    <div class="flex-row">
      <button class="btn" (click)="refreshData()" title="Sync data with server">
        <span class="material-icons">refresh</span>
        <span>同期 (Sync)</span>
      </button>
      <button class="btn gradient-warning" (click)="handleUpdate()" [disabled]="loading()" id="run-analysis-btn">
        <span class="material-icons">{{ loading() ? 'hourglass_empty' : 'analytics' }}</span>
        <span>{{ loading() ? '分析中...' : '分析を実行 (Run Analysis)' }}</span>
      </button>
    </div>
  </header>

  <div class="dashboard-grid">
    <!-- Left Column: Settings and Portfolio -->
    <div class="flex-col">
      <section class="card">
        <h2>Add Stock</h2>
        <div class="form-group">
          <label>Ticker (e.g. 7203, 9984)</label>
          <div class="flex-input-group">
            <input [(ngModel)]="newStockCode" placeholder="Stock Code" (keyup.enter)="lookupStockInfo()">
            <button class="btn px-0-5" (click)="lookupStockInfo()" [disabled]="isLookingUp">
              <span class="material-icons">{{ isLookingUp ? 'sync' : 'search' }}</span>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>Company Name</label>
          <input [(ngModel)]="newStockName" placeholder="Name">
        </div>
        <button class="btn width-full" (click)="handleAddStock()" [disabled]="!newStockCode || !newStockName">
          <span class="material-icons">add_chart</span>
          <span>Add to Watchlist</span>
        </button>
      </section>

      <!-- Portfolio Section -->
      <section class="card">
        <h2>Portfolio </h2>
        <div *ngIf="portfolioItems().length === 0"
          class="p-1 text-center text-muted">
          保有株はありません。
        </div>
        <div *ngFor="let item of portfolioItems()"
          class="border-bottom-thin p-0-75">
          <div class="flex-between">
            <div>
              <span class="badge badge-blue">#{{ item.code }}</span>
              <span class="text-bold text-small ml-0-5">{{ item.name }}</span>
            </div>
            <button class="btn-icon-action btn-icon-red" (click)="handleSell(item)" title="売却">
              <span class="material-icons icon-lg">exit_to_app</span>
            </button>
          </div>
          <div class="flex-spacer">
            <span class="text-muted">{{ item.shares }}株 @ ¥{{ item.purchasePrice | number }}</span>
            <span *ngIf="item.currentPrice"
              [style.color]="(item.currentPrice - item.purchasePrice) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'"
              class="text-bold-lg">
              {{ (item.currentPrice - item.purchasePrice) * item.shares | number }}
              ({{ (item.currentPrice - item.purchasePrice) / item.purchasePrice | percent:'1.1-1' }})
            </span>
          </div>
        </div>
      </section>

      <section class="card" *ngIf="logs().length > 0">
        <h2>Process Logs</h2>
        <div class="log-box">
          <div *ngFor="let log of logs()">> {{ log }}</div>
        </div>
      </section>
    </div>

    <!-- Right Column: Results -->
    <div class="flex-col">
      <!-- Sell Signals Area -->
      <section class="card" *ngIf="signals().length > 0">
        <h2 class="color-red"><span class="material-icons">trending_down</span> Sell Signals </h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Code</th>
              <th>Reason</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let s of signals()">
              <tr *ngIf="s.type === 'SELL'">
                <td>{{ s.date | date:'shortDate' }}</td>
                <td><span class="badge badge-red">#{{ s.code }}</span></td>
                <td class="text-small">{{ s.reason }}</td>
                <td>
                  <button class="btn btn-icon btn-icon-action btn-icon-red" (click)="handleBuy(s.code, s.targetPrice)">
                    <span class="material-icons">sell</span>
                  </button>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2 class="color-green"><span class="material-icons">trending_up</span> Buy Signals </h2>
        <div *ngIf="signals().length === 0" class="p-1 text-center text-muted">
          No buy signals detected today. Run analysis to scan the market.
        </div>
        <table class="data-table" *ngIf="signals().length > 0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Code</th>
              <th>Target</th>
              <th>TP / SL</th>
              <th>Buy</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let s of signals()">
              <tr *ngIf="s.type === 'BUY'">
                <td>{{ s.date | date:'shortDate' }}</td>
                <td><span class="badge badge-blue">#{{ s.code }}</span></td>
                <td class="text-bold">¥{{ s.targetPrice | number }}</td>
                <td class="text-small">
                  <span class="text-color-green">TP:¥{{ s.tp | number }}</span><br>
                  <span class="text-color-red">SL:¥{{ s.sl | number }}</span>
                </td>
                <td>
                  <button class="btn btn-icon btn-icon-action btn-icon-green" (click)="handleBuy(s.code, s.targetPrice)">
                    <span class="material-icons">shopping_cart</span>
                  </button>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Watchlist</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Price</th>
              <th>Change</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let stock of stocks()">
              <td><span class="badge badge-blue">{{ stock.code }}</span></td>
              <td>{{ stock.name }}</td>
              <td class="text-bold">{{ stock.currentPrice ? '¥' + (stock.currentPrice | number) : '-' }}</td>
              <td>
                <span *ngIf="stock.currentPrice && stock.prevClose"
                  [style.color]="(stock.currentPrice - stock.prevClose) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'"
                  class="text-bold">
                  {{ (stock.currentPrice - stock.prevClose) / stock.prevClose | percent:'1.1-1' }}
                </span>
                <span *ngIf="!stock.currentPrice || !stock.prevClose" class="text-muted">-</span>
              </td>
              <td>
                <span class="badge" [ngClass]="stock.hasDataToday ? 'badge-green' : 'badge-red'">
                  {{ stock.hasDataToday ? 'Synced' : 'Old' }}
                </span>
              </td>
              <td>
                <div class="flex-icon-row">
                  <button class="btn-icon-action btn-icon-green" (click)="handleBuy(stock.code, stock.currentPrice || 0)" title="購入">
                    <span class="material-icons icon-lg">shopping_cart</span>
                  </button>
                  <button class="btn-icon-action btn-icon-red p-2px" (click)="handleDeleteStock(stock.code)" title="Delete Stock">
                    <span class="material-icons icon-lg">delete_outline</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div class="modal-overlay" *ngIf="isModalOpen()">
    <div class="modal-card">
      <div class="modal-header">
        <span class="material-icons color-modal-icon mr-0-5">warning</span>
        <h3>銘柄の削除</h3>
      </div>
      <div class="modal-body">
        <p>銘柄コード <span class="badge badge-blue">#{{ stockToDelete() }}</span> を<br>ウォッチリストから削除しますか？</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="cancelDelete()">キャンセル</button>
        <button class="btn-danger" (click)="confirmDelete()">削除する</button>
      </div>
    </div>
  </div>
</div>
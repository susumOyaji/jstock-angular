<div class="container">
  <header>
    <h1>J-Stock Auto Planner <span
        style="font-size: 0.5em; vertical-align: middle; color: var(--text-muted); font-weight: 300;">powered by
        Antigravity</span></h1>
    <div style="display: flex; gap: 1rem; align-items: center;">
      <button class="btn" (click)="refreshData()" title="Sync data with server">
        <span class="material-icons">refresh</span>
        <span>åŒæœŸ (Sync)</span>
      </button>
      <button class="btn" (click)="handleUpdate()" [disabled]="loading()" id="run-analysis-btn"
        style="background: linear-gradient(135deg, #f59e0b, #ef4444);">
        <span class="material-icons">{{ loading() ? 'hourglass_empty' : 'analytics' }}</span>
        <span>{{ loading() ? 'åˆ†æä¸­...' : 'åˆ†æã‚’å®Ÿè¡Œ (Run Analysis)' }}</span>
      </button>
      <button class="btn" (click)="handleBuy('7203', 1500)"
        style="background: linear-gradient(135deg, #10b981, #059669);">
        <span class="material-icons">shopping_cart</span>
        <span>ğŸ§ª Test Buy (7203)</span>
      </button>
    </div>
  </header>

  <div class="dashboard-grid">
    <!-- Left Column: Settings and Portfolio -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
      <section class="card">
        <h2>Add Stock</h2>
        <div class="form-group">
          <label>Ticker (e.g. 7203, 9984)</label>
          <div style="display: flex; gap: 0.5rem;">
            <input [(ngModel)]="newStockCode" placeholder="Stock Code" (keyup.enter)="lookupStockInfo()">
            <button class="btn" style="padding: 0.5rem;" (click)="lookupStockInfo()" [disabled]="isLookingUp">
              <span class="material-icons">{{ isLookingUp ? 'sync' : 'search' }}</span>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>Company Name</label>
          <input [(ngModel)]="newStockName" placeholder="Name">
        </div>
        <button class="btn" style="width: 100%;" (click)="handleAddStock()" [disabled]="!newStockCode || !newStockName">
          <span class="material-icons">add_chart</span>
          <span>éŠ˜æŸ„ã‚’è¿½åŠ  (Add to Watchlist)</span>
        </button>
      </section>

      <!-- Portfolio Section -->
      <section class="card">
        <h2>Portfolio (ä¿æœ‰æ ª)</h2>
        <div *ngIf="portfolioItems().length === 0"
          style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.9em;">
          ä¿æœ‰æ ªã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
        <div *ngFor="let item of portfolioItems()"
          style="border-bottom: 1px solid rgba(255,255,255,0.05); padding: 0.75rem 0;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span class="badge badge-blue">#{{ item.code }}</span>
              <span style="font-weight: 600; font-size: 0.9rem; margin-left: 0.5rem;">{{ item.name }}</span>
            </div>
            <button class="btn-icon" (click)="handleSell(item)" title="å£²å´"
              style="color: var(--accent-red); background: none; border: none; cursor: pointer;">
              <span class="material-icons" style="font-size: 1.1rem;">exit_to_app</span>
            </button>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-top: 0.4rem;">
            <span style="color: var(--text-muted);">{{ item.shares }}æ ª @ Â¥{{ item.purchasePrice | number }}</span>
            <span *ngIf="item.currentPrice"
              [style.color]="(item.currentPrice - item.purchasePrice) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'"
              style="font-weight: 700;">
              {{ (item.currentPrice - item.purchasePrice) * item.shares | number }}
              ({{ (item.currentPrice - item.purchasePrice) / item.purchasePrice | percent:'1.1-1' }})
            </span>
          </div>
        </div>
      </section>

      <section class="card" *ngIf="logs().length > 0">
        <h2>Process Logs</h2>
        <div class="log-box">
          <div *ngFor="let log of logs()">> {{ log }}</div>
        </div>
      </section>
    </div>

    <!-- Right Column: Results -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
      <!-- Sell Signals Area -->
      <section class="card" *ngIf="signals().length > 0">
        <h2 style="color: #f87171;"><span class="material-icons">trending_down</span> Sell Signals (å£²ã‚Šæ¨å¥¨)</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Code</th>
              <th>Reason</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let s of signals()">
              <tr *ngIf="s.type === 'SELL'">
                <td>{{ s.date | date:'shortDate' }}</td>
                <td><span class="badge badge-red">#{{ s.code }}</span></td>
                <td style="font-size: 0.85rem;">{{ s.reason }}</td>
                <td>
                  <button class="btn btn-icon" (click)="handleBuy(s.code, s.targetPrice)"
                    style="background: transparent; color: var(--accent-red); border: none; cursor: pointer;">
                    <span class="material-icons">sell</span>
                  </button>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2 style="color: #4ade80;"><span class="material-icons">trending_up</span> Buy Signals (è²·ã„æ¨å¥¨)</h2>
        <div *ngIf="signals().length === 0" style="padding: 2rem; text-align: center; color: var(--text-muted);">
          No buy signals detected today. Run analysis to scan the market.
        </div>
        <table class="data-table" *ngIf="signals().length > 0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Code</th>
              <th>Target</th>
              <th>TP / SL</th>
              <th>Buy</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let s of signals()">
              <tr *ngIf="s.type === 'BUY'">
                <td>{{ s.date | date:'shortDate' }}</td>
                <td><span class="badge badge-blue">#{{ s.code }}</span></td>
                <td style="font-weight: 600;">Â¥{{ s.targetPrice | number }}</td>
                <td style="font-size: 0.85em;">
                  <span style="color: var(--accent-green);">TP:Â¥{{ s.tp | number }}</span><br>
                  <span style="color: var(--accent-red);">SL:Â¥{{ s.sl | number }}</span>
                </td>
                <td>
                  <button class="btn btn-icon" (click)="handleBuy(s.code, s.targetPrice)"
                    style="background: transparent; color: var(--accent-green); border: none; cursor: pointer;">
                    <span class="material-icons">shopping_cart</span>
                  </button>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Watchlist</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Price</th>
              <th>Change</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let stock of stocks()">
              <td><span class="badge badge-blue">{{ stock.code }}</span></td>
              <td>{{ stock.name }}</td>
              <td style="font-weight: 600;">{{ stock.currentPrice ? 'Â¥' + (stock.currentPrice | number) : '-' }}</td>
              <td>
                <span *ngIf="stock.currentPrice && stock.prevClose"
                  [style.color]="(stock.currentPrice - stock.prevClose) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'"
                  style="font-weight: 600;">
                  {{ (stock.currentPrice - stock.prevClose) / stock.prevClose | percent:'1.1-1' }}
                </span>
                <span *ngIf="!stock.currentPrice || !stock.prevClose" style="color: var(--text-muted);">-</span>
              </td>
              <td>
                <span class="badge" [ngClass]="stock.hasDataToday ? 'badge-green' : 'badge-red'">
                  {{ stock.hasDataToday ? 'Synced' : 'Old' }}
                </span>
              </td>
              <td>
                <div style="display: flex; gap: 0.5rem;">
                  <button class="btn-icon" (click)="handleBuy(stock.code, stock.currentPrice || 0)" title="è³¼å…¥"
                    style="color: var(--accent-green); background: none; border: none; cursor: pointer;">
                    <span class="material-icons" style="font-size: 1.1rem;">shopping_cart</span>
                  </button>
                  <button class="btn-icon" (click)="handleDeleteStock(stock.code)" title="Delete Stock"
                    style="background: transparent; color: var(--accent-red); padding: 2px; border: none; cursor: pointer;">
                    <span class="material-icons" style="font-size: 1.1rem;">delete_outline</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div class="modal-overlay" *ngIf="isModalOpen()">
    <div class="modal-card">
      <div class="modal-header">
        <span class="material-icons" style="color: #ef4444; margin-right: 0.5rem;">warning</span>
        <h3>éŠ˜æŸ„ã®å‰Šé™¤</h3>
      </div>
      <div class="modal-body">
        <p>éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ <span class="badge badge-blue">#{{ stockToDelete() }}</span> ã‚’<br>ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="cancelDelete()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-danger" (click)="confirmDelete()">å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>